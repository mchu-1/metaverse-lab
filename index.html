<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Network Lab</title>
    <meta name="description" content="Network Lab - 360 View" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
      /* Ensure the scene takes up the full viewport */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000;
      }
    </style>
  </head>
  <body>
    <!-- 
      vr-mode-ui="enabled: true" enables the VR button.
      device-orientation-permission-ui handles iOS 13+ permission request automatically (in recent A-Frame versions).
    -->
    <a-scene vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: true">
      <a-assets>
        <img id="sky" src="nslab-world.png" />
      </a-assets>

      <!-- 360 Sky Sphere -->
      <a-sky src="#sky" rotation="0 -130 0"></a-sky>

      <!-- Camera with look controls -->
      <!-- reverseMouseDrag: true is often preferred for 360 drag interaction -->
      <a-entity
        camera
        look-controls="reverseMouseDrag: true; touchEnabled: true"
        position="0 1.6 0"
      ></a-entity>
    </a-scene>
    <div id="ui-controls">
      <button id="btn-fullscreen" class="ui-btn" aria-label="Toggle Fullscreen">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
        </svg>
      </button>
      <button id="btn-reset" class="ui-btn" aria-label="Reset View">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
        </svg>
      </button>
      <!-- Custom VR Button -->
      <button id="btn-vr" class="ui-btn" aria-label="Enter VR">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm-7 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm16 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
        </svg>
      </button>
    </div>

    <script>
      // UI Logic
      const btnFullscreen = document.getElementById('btn-fullscreen');
      const btnReset = document.getElementById('btn-reset');
      const btnVr = document.getElementById('btn-vr');
      const scene = document.querySelector('a-scene');
      const cameraEntity = document.querySelector('[camera]');

      // Fullscreen Toggle
      btnFullscreen.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      });

      // Reset View
      btnReset.addEventListener('click', () => {
        // Reset camera rotation and position logic
        // For A-Frame look-controls, we might need to reset the component's internal state or the entity's rotation.
        // A simple way is to reset the rotation attribute, but look-controls overrides it.
        // We can access the look-controls component to reset pitch/yaw.
        
        if (cameraEntity) {
           cameraEntity.setAttribute('rotation', '0 0 0');
           // If using look-controls, we often need to zero out its internal pitch/yaw objects
           const controls = cameraEntity.components['look-controls'];
           if (controls) {
             controls.pitchObject.rotation.x = 0;
             controls.yawObject.rotation.y = 0;
           }
        }
      });

      // VR Toggle
      btnVr.addEventListener('click', () => {
        if (scene.is('vr-mode')) {
          scene.exitVR();
        } else {
          scene.enterVR();
        }
      });
    </script>
    <style>
      #ui-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
      }
      
      .ui-btn {
        background: rgba(20, 20, 20, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        padding: 10px;
        cursor: pointer;
        backdrop-filter: blur(4px);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .ui-btn:hover {
        background: rgba(20, 20, 20, 0.8);
        transform: translateY(-2px);
      }
      
      .ui-btn:active {
        transform: translateY(0);
      }

      /* Accessibility Tree (Visually Hidden) */
      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }


    </style>

    <!-- Hidden Accessibility Layer for AI Agents -->
    <div id="accessibility-tree" class="visually-hidden" aria-hidden="false">
      <section id="env-reason" aria-labelledby="reason-title">
        <h1 id="reason-title">Environment Purpose</h1>
        <div id="reason-content"></div>
      </section>
      <section id="env-equipment" aria-labelledby="equipment-title">
        <h2 id="equipment-title">Laboratory Equipment</h2>
        <div id="equipment-list"></div>
      </section>
      <section id="env-annotations" aria-labelledby="annotations-title">
        <h2 id="annotations-title">Annotated Objects</h2>
        <div id="annotations-list"></div>
      </section>
      <section id="env-legal" aria-labelledby="legal-title">
        <h2 id="legal-title">Legal & Compliance</h2>
        <div id="legal-list"></div>
      </section>
    </div>

    <script>
      // Load and inject metadata
      async function loadMetadata() {
        try {
          // Load Reason
          const reasonRes = await fetch('reason.txt');
          if (reasonRes.ok) {
            const reasonText = await reasonRes.text();
            document.getElementById('reason-content').innerText = reasonText;
          }

          // Load Equipment
          const equipRes = await fetch('equipment.csv');
          if (equipRes.ok) {
            const csvText = await equipRes.text();
            const equipmentData = parseCSV(csvText);
            renderTable(equipmentData, 'equipment-list');
          }

          // Load Legal
          const legalRes = await fetch('legal.csv');
          if (legalRes.ok) {
            const legalText = await legalRes.text();
            const legalData = parseCSV(legalText);
            renderTable(legalData, 'legal-list');
          }

          // Load Annotations
          const annRes = await fetch('annotations.csv');
          if (annRes.ok) {
            const annText = await annRes.text();
            const annData = parseCSV(annText);
            renderAnnotations(annData, 'annotations-list');
          }

        } catch (e) {
          console.error("Failed to load metadata:", e);
        }
      }

      function parseCSV(text) {
        // Simple CSV parser handling quotes
        const lines = text.trim().split('\n');
        if (lines.length < 2) return []; // Access headers safely
        const headers = parseLine(lines[0]);
        
        return lines.slice(1).map(line => {
          const values = parseLine(line);
          return headers.reduce((obj, header, index) => {
            obj[header.trim()] = values[index];
            return obj;
          }, {});
        });
      }

      function parseLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      }

      function renderTable(data, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        if (!data || data.length === 0) return;

        // Headers
        const headers = Object.keys(data[0]);
        const trHead = document.createElement('tr');
        headers.forEach(h => {
          const th = document.createElement('th');
          th.innerText = h;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        // Rows
        data.forEach(item => {
          const tr = document.createElement('tr');
          headers.forEach(h => {
            const td = document.createElement('td');
            td.innerText = item[h] || '';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        container.appendChild(table);
      }

      function renderAnnotations(data, containerId) {
        const container = document.getElementById(containerId);
        if (!container || !data || data.length === 0) return;

        // Source image dimensions for normalization
        const SOURCE_WIDTH = 1024;
        const SOURCE_HEIGHT = 506;

        const uList = document.createElement('ul');
        
        data.forEach(item => {
          const x = parseFloat(item.x);
          const y = parseFloat(item.y);
          const w = parseFloat(item.width);
          const h = parseFloat(item.height);
          
          if (isNaN(x) || isNaN(y)) return;

          // Normalize to percentage
          const top = (y / SOURCE_HEIGHT * 100).toFixed(2);
          const left = (x / SOURCE_WIDTH * 100).toFixed(2);
          const width = (w / SOURCE_WIDTH * 100).toFixed(2);
          const height = (h / SOURCE_HEIGHT * 100).toFixed(2);

          const li = document.createElement('li');
          // Text description for AI agent
          li.innerText = `${item.annotation}: located at position top=${top}%, left=${left}%, width=${width}%, height=${height}% of the equirectangular view.`;
          uList.appendChild(li);
        });

        container.appendChild(uList);
      }

      // Initialize
      loadMetadata();
    </script>
  </body>
</html>
